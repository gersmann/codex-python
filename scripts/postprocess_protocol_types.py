#!/usr/bin/env python3
from __future__ import annotations

import re
from pathlib import Path


def main() -> int:
    p = Path("codex/protocol/types.py")
    s = p.read_text()

    # Fix recursive JsonValue forward refs to satisfy ruff F821
    # Quote bare JsonValue inside RootModel[...] first
    s = re.sub(r"RootModel\[([^\]]*?)JsonValue([^\]]*?)\]", r"RootModel[\1'JsonValue'\2]", s)
    # Then fix container occurrences
    s = re.sub(r"list\[JsonValue\]", "list['JsonValue']", s)
    s = re.sub(r"dict\[str, JsonValue\]", "dict[str, 'JsonValue']", s)
    # Normalize accidental double quotes if any
    s = s.replace("''JsonValue''", "'JsonValue'")

    # Add noqa for forward refs in union aliases so ruff F821 doesn't fire
    import re as _re

    # For RootModel union wrappers, drop the type parameter to avoid forward-ref NameError at class creation
    s = _re.sub(
        r"class\s+(EventMsg|ClientRequest|ServerRequest|ServerNotification|InputItem)\s*\(\s*RootModel\[[^\]]+\]\s*\):",
        lambda m: f"class {m.group(1)}(RootModel):",
        s,
    )
    s = _re.sub(r"(\s+root:\s*\([^\)]+\))", r"\1  # noqa: F821", s)
    # If previous runs introduced quotes around variant names, strip them inside union lines
    s = _re.sub(
        r"'((?:EventMsg|ClientRequest|ServerRequest|ServerNotification|InputItem)[A-Za-z0-9_]+)'",
        r"\1",
        s,
    )

    # Add a file-level ruff directive to ignore F821 in the generated file
    if "# ruff: noqa: F821" not in s.splitlines()[:5]:
        lines = s.splitlines()
        # insert after the header comment block (first non-empty line)
        for idx, line in enumerate(lines[:10]):
            if line.startswith("# generated by"):
                insert_at = idx + 1
                break
        else:
            insert_at = 1
        lines.insert(insert_at, "# ruff: noqa: F821")
        s = "\n".join(lines) + ("\n" if not s.endswith("\n") else "")

    p.write_text(s)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
